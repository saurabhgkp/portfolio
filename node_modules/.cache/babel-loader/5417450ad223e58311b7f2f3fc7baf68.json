{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.LooksAhead = void 0;\n\nvar lookahead_1 = require(\"../../grammar/lookahead\");\n\nvar utils_1 = require(\"@chevrotain/utils\");\n\nvar parser_1 = require(\"../parser\");\n\nvar keys_1 = require(\"../../grammar/keys\");\n\nvar gast_1 = require(\"../../grammar/gast/gast\");\n/**\n * Trait responsible for the lookahead related utilities and optimizations.\n */\n\n\nvar LooksAhead =\n/** @class */\nfunction () {\n  function LooksAhead() {}\n\n  LooksAhead.prototype.initLooksAhead = function (config) {\n    this.dynamicTokensEnabled = utils_1.has(config, \"dynamicTokensEnabled\") ? config.dynamicTokensEnabled : parser_1.DEFAULT_PARSER_CONFIG.dynamicTokensEnabled;\n    this.maxLookahead = utils_1.has(config, \"maxLookahead\") ? config.maxLookahead : parser_1.DEFAULT_PARSER_CONFIG.maxLookahead;\n    /* istanbul ignore next - Using plain array as dictionary will be tested on older node.js versions and IE11 */\n\n    this.lookAheadFuncsCache = utils_1.isES2015MapSupported() ? new Map() : []; // Performance optimization on newer engines that support ES6 Map\n    // For larger Maps this is slightly faster than using a plain object (array in our case).\n\n    /* istanbul ignore else - The else branch will be tested on older node.js versions and IE11 */\n\n    if (utils_1.isES2015MapSupported()) {\n      this.getLaFuncFromCache = this.getLaFuncFromMap;\n      this.setLaFuncCache = this.setLaFuncCacheUsingMap;\n    } else {\n      this.getLaFuncFromCache = this.getLaFuncFromObj;\n      this.setLaFuncCache = this.setLaFuncUsingObj;\n    }\n  };\n\n  LooksAhead.prototype.preComputeLookaheadFunctions = function (rules) {\n    var _this = this;\n\n    utils_1.forEach(rules, function (currRule) {\n      _this.TRACE_INIT(currRule.name + \" Rule Lookahead\", function () {\n        var _a = gast_1.collectMethods(currRule),\n            alternation = _a.alternation,\n            repetition = _a.repetition,\n            option = _a.option,\n            repetitionMandatory = _a.repetitionMandatory,\n            repetitionMandatoryWithSeparator = _a.repetitionMandatoryWithSeparator,\n            repetitionWithSeparator = _a.repetitionWithSeparator;\n\n        utils_1.forEach(alternation, function (currProd) {\n          var prodIdx = currProd.idx === 0 ? \"\" : currProd.idx;\n\n          _this.TRACE_INIT(\"\" + gast_1.getProductionDslName(currProd) + prodIdx, function () {\n            var laFunc = lookahead_1.buildLookaheadFuncForOr(currProd.idx, currRule, currProd.maxLookahead || _this.maxLookahead, currProd.hasPredicates, _this.dynamicTokensEnabled, _this.lookAheadBuilderForAlternatives);\n            var key = keys_1.getKeyForAutomaticLookahead(_this.fullRuleNameToShort[currRule.name], keys_1.OR_IDX, currProd.idx);\n\n            _this.setLaFuncCache(key, laFunc);\n          });\n        });\n        utils_1.forEach(repetition, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, keys_1.MANY_IDX, lookahead_1.PROD_TYPE.REPETITION, currProd.maxLookahead, gast_1.getProductionDslName(currProd));\n        });\n        utils_1.forEach(option, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, keys_1.OPTION_IDX, lookahead_1.PROD_TYPE.OPTION, currProd.maxLookahead, gast_1.getProductionDslName(currProd));\n        });\n        utils_1.forEach(repetitionMandatory, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, keys_1.AT_LEAST_ONE_IDX, lookahead_1.PROD_TYPE.REPETITION_MANDATORY, currProd.maxLookahead, gast_1.getProductionDslName(currProd));\n        });\n        utils_1.forEach(repetitionMandatoryWithSeparator, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, keys_1.AT_LEAST_ONE_SEP_IDX, lookahead_1.PROD_TYPE.REPETITION_MANDATORY_WITH_SEPARATOR, currProd.maxLookahead, gast_1.getProductionDslName(currProd));\n        });\n        utils_1.forEach(repetitionWithSeparator, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, keys_1.MANY_SEP_IDX, lookahead_1.PROD_TYPE.REPETITION_WITH_SEPARATOR, currProd.maxLookahead, gast_1.getProductionDslName(currProd));\n        });\n      });\n    });\n  };\n\n  LooksAhead.prototype.computeLookaheadFunc = function (rule, prodOccurrence, prodKey, prodType, prodMaxLookahead, dslMethodName) {\n    var _this = this;\n\n    this.TRACE_INIT(\"\" + dslMethodName + (prodOccurrence === 0 ? \"\" : prodOccurrence), function () {\n      var laFunc = lookahead_1.buildLookaheadFuncForOptionalProd(prodOccurrence, rule, prodMaxLookahead || _this.maxLookahead, _this.dynamicTokensEnabled, prodType, _this.lookAheadBuilderForOptional);\n      var key = keys_1.getKeyForAutomaticLookahead(_this.fullRuleNameToShort[rule.name], prodKey, prodOccurrence);\n\n      _this.setLaFuncCache(key, laFunc);\n    });\n  };\n\n  LooksAhead.prototype.lookAheadBuilderForOptional = function (alt, tokenMatcher, dynamicTokensEnabled) {\n    return lookahead_1.buildSingleAlternativeLookaheadFunction(alt, tokenMatcher, dynamicTokensEnabled);\n  };\n\n  LooksAhead.prototype.lookAheadBuilderForAlternatives = function (alts, hasPredicates, tokenMatcher, dynamicTokensEnabled) {\n    return lookahead_1.buildAlternativesLookAheadFunc(alts, hasPredicates, tokenMatcher, dynamicTokensEnabled);\n  }; // this actually returns a number, but it is always used as a string (object prop key)\n\n\n  LooksAhead.prototype.getKeyForAutomaticLookahead = function (dslMethodIdx, occurrence) {\n    var currRuleShortName = this.getLastExplicitRuleShortName();\n    return keys_1.getKeyForAutomaticLookahead(currRuleShortName, dslMethodIdx, occurrence);\n  };\n  /* istanbul ignore next */\n\n\n  LooksAhead.prototype.getLaFuncFromCache = function (key) {\n    return undefined;\n  };\n\n  LooksAhead.prototype.getLaFuncFromMap = function (key) {\n    return this.lookAheadFuncsCache.get(key);\n  };\n  /* istanbul ignore next - Using plain array as dictionary will be tested on older node.js versions and IE11 */\n\n\n  LooksAhead.prototype.getLaFuncFromObj = function (key) {\n    return this.lookAheadFuncsCache[key];\n  };\n  /* istanbul ignore next */\n\n\n  LooksAhead.prototype.setLaFuncCache = function (key, value) {};\n\n  LooksAhead.prototype.setLaFuncCacheUsingMap = function (key, value) {\n    this.lookAheadFuncsCache.set(key, value);\n  };\n  /* istanbul ignore next - Using plain array as dictionary will be tested on older node.js versions and IE11 */\n\n\n  LooksAhead.prototype.setLaFuncUsingObj = function (key, value) {\n    this.lookAheadFuncsCache[key] = value;\n  };\n\n  return LooksAhead;\n}();\n\nexports.LooksAhead = LooksAhead;","map":{"version":3,"mappings":"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","names":["LooksAhead","config","dynamicTokensEnabled","utils_1","parser_1","maxLookahead","lookAheadFuncsCache","Map","getLaFuncFromCache","getLaFuncFromMap","setLaFuncCache","setLaFuncCacheUsingMap","getLaFuncFromObj","setLaFuncUsingObj","rules","currRule","_this","TRACE_INIT","name","gast_1","alternation","repetition","option","repetitionMandatory","repetitionMandatoryWithSeparator","repetitionWithSeparator","currProd","prodIdx","idx","laFunc","lookahead_1","hasPredicates","lookAheadBuilderForAlternatives","key","keys_1","fullRuleNameToShort","computeLookaheadFunc","REPETITION","OPTION","REPETITION_MANDATORY","REPETITION_MANDATORY_WITH_SEPARATOR","REPETITION_WITH_SEPARATOR","rule","prodOccurrence","prodKey","prodType","prodMaxLookahead","dslMethodName","lookAheadBuilderForOptional","alt","tokenMatcher","alts","dslMethodIdx","occurrence","currRuleShortName","getLastExplicitRuleShortName","undefined","get","value","set","exports"],"sourceRoot":"","sources":["../../../../../src/parse/parser/traits/looksahead.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}